---
title: "non-uva.Rmd"
output: html_document
date: "2025-04-04"
---

```{r}
library(dplyr)
library(tidyverse)
library(leaflet)
library(lubridate)
library(sf)
library(leaflet.extras)
library(readr)
df <- read_csv("~/Downloads/Transit_2020.csv")
```

```{r}
df <- read.csv("~/Downloads/Transit_2020.csv")

df$FareCategory <- ifelse(grepl("UVA", df$FareCategory), "UVA", "Non-UVA")

# Step 2: Classify stops based on whether they EVER had a UVA fare
stop_type <- df %>%
  group_by(Stop) %>%
  summarise(StopType = ifelse(any(FareCategory == "UVA"), "UVA Stop", "Non-UVA Stop"))

# Step 3: Join back into original data
df <- df %>%
  left_join(stop_type, by = "Stop")

# Step 2: Create time features
df <- df %>%
  mutate(Date_Time = ymd_hms(Date_Time),
         Hour = hour(Date_Time),
         Date = as.Date(Date_Time))

# Step 3: Filter to weekdays
df_weekdays <- df %>%
  filter(wday(Date_Time) %in% 2:6)

# Step 4: Total ridership per hour per day per StopType
hourly_totals <- df_weekdays %>%
  group_by(StopType, Date, Hour) %>%
  summarise(Daily_Total_Ridership = sum(Count, na.rm = TRUE), .groups = "drop")

# Step 5: Average ridership per hour per StopType
hourly_avg <- hourly_totals %>%
  group_by(StopType, Hour) %>%
  summarise(Average_Ridership = mean(Daily_Total_Ridership, na.rm = TRUE), .groups = "drop")

#visualization
ggplot(filter(hourly_avg, StopType == "Non-UVA Stop"),
       aes(x = Hour, y = Average_Ridership)) +
  geom_bar(stat = "identity", fill = "firebrick") +
  labs(title = "Weekday Average Ridership per Hour – Non-UVA Stops",
       x = "Hour of the Day", y = "Average Ridership per Hour") +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 23, 1))
```

```{r}
library(ggplot2)
library(gganimate)
library(lubridate)
library(dplyr)

# Read data and process
df <- read.csv("~/Downloads/Transit_2020.csv")

df$FareCategory <- ifelse(grepl("UVA", df$FareCategory), "UVA", "Non-UVA")

stop_type <- df %>%
  group_by(Stop) %>%
  summarise(StopType = ifelse(any(FareCategory == "UVA"), "UVA Stop", "Non-UVA Stop"))

df <- df %>%
  left_join(stop_type, by = "Stop") %>%
  mutate(Date_Time = ymd_hms(Date_Time),
         Hour = hour(Date_Time),
         Date = as.Date(Date_Time))

df_weekdays <- df %>%
  filter(wday(Date_Time) %in% 2:6)

hourly_totals <- df_weekdays %>%
  group_by(StopType, Date, Hour) %>%
  summarise(Daily_Total_Ridership = sum(Count, na.rm = TRUE), .groups = "drop")

hourly_avg <- hourly_totals %>%
  group_by(StopType, Hour) %>%
  summarise(Average_Ridership = mean(Daily_Total_Ridership, na.rm = TRUE), .groups = "drop")

# Create a static ggplot for UVA Stop
p <- ggplot(filter(hourly_avg, StopType == "Non-UVA Stop"), 
            aes(x = Hour, y = Average_Ridership)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Weekday Average Ridership per Hour – Non-UVA Stops",
       subtitle = "Hour: {frame_time}",
       x = "Hour of the Day", y = "Average Ridership per Hour") +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 23, 1)) +
  transition_time(Hour) +
  ease_aes('linear')

# Animate and save the output
anim <- animate(p, nframes = 24, fps = 4, width = 600, height = 400, renderer = gifski_renderer(),end_pause = 10)
anim_save("animated_histogram.gif", animation = anim)
```

```{r}
# install.packages("ggplot2")
# install.packages("gganimate")
# install.packages("magick")
# install.packages("gifski")

library(ggplot2)
library(gganimate)
library(dplyr)
library(lubridate)

# (Your data prep code here) --------------------
# df <- read.csv("~/Downloads/Transit_2020.csv")
# ... filtering, grouping, summarizing ...
# We'll assume `hourly_avg` has columns StopType, Hour, and Average_Ridership.

# Filter for UVA Stop, each Hour is a separate 'state' in the animation
df_anim <- hourly_avg %>%
  filter(StopType == "Non-UVA Stop")

p1 <- ggplot(df_anim, aes(x = Hour, y = Average_Ridership)) +
  geom_bar(stat = "identity", fill = "firebrick") +
  labs(title = "Weekday Average Ridership per Hour – Non-UVA Stops",
       subtitle = "Hour: {closest_state}",
       x = "Hour of the Day", y = "Average Ridership per Hour") +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 23, 1)) +
  transition_states(Hour, wrap = FALSE) +
  enter_fade() + 
  exit_fade()

# Animate with loop=FALSE so it doesn't repeat
# (We'll append a static image next, so no need for end_pause)
anim <- animate(
  p1,
  nframes = 24,
  fps = 4,
  width = 600,
  height = 400,
  renderer = gifski_renderer(loop = FALSE)  # single pass
)
```

```{r}
library(magick)

# Convert the gganimate object to magick frames
img_frames <- image_read(anim)

# Read your final static histogram image
final_frame <- image_read("images/non_final_frame.png")

# Optional: match size to animation frames
# e.g., if final_frame is 800x600, but your animation is 600x400:
img_info <- image_info(img_frames[1])
w <- img_info$width
h <- img_info$height

# Resize the final frame to match (e.g., "600x400")
geometry_string <- paste0(w, "x", h)
final_frame <- image_resize(final_frame, geometry = geometry_string)

# Combine all frames + final static image
all_frames <- c(img_frames, final_frame)

# Write out the combined GIF
image_write_gif(all_frames, "comb_nonuva_histogram.gif", delay = 0.3, loop=0)

```
